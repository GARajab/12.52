<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>PS4 Payload Loader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f2f5;
            color: #000;
            transition: background 0.3s, color 0.3s;
        }

        body.dark {
            background: #0e0e0e;
            color: #fff;
        }

        header {
            background: #1877f2;
            color: #fff;
            padding: 14px;
            font-size: 22px;
            font-weight: 600;
            width: 100%;
            text-align: center;
        }

        #status {
            background: #fff;
            padding: 10px;
            font-size: 14px;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
            width: 90%;
            max-width: 520px;
        }

        body.dark #status {
            background: #1a1a1a;
            border: 1px solid #555;
            color: #fff;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .controls button {
            border: none;
            background: #1877f2;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .controls button.active {
            background: #0d60c6;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 1120px;
            width: 95%;
            margin-bottom: 20px;
        }

        .container.grid {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            padding: 14px;
            margin: 6px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            text-align: center;
            transition: background 0.3s, color 0.3s;
            color: #000;
        }

        body.dark .card {
            background: #1a1a1a;
            color: #fff;
        }

        .card h2 {
            margin: 0 0 6px;
            font-size: 17px;
        }

        .card .desc {
            font-size: 14px;
            color: #65676b;
        }

        body.dark .card .desc {
            color: #ccc;
        }

        .card .meta {
            font-size: 12px;
            color: #8a8d91;
            margin: 6px 0;
        }

        body.dark .card .meta {
            color: #aaa;
        }

        .card .send {
            margin-top: 10px;
            width: 80%;
            max-width: 200px;
            padding: 9px;
            background: #1877f2;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .card .send:hover {
            background: #0d60c6;
        }

        .lang,
        .view-mode {
            position: fixed;
            bottom: 10px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
            display: flex;
            gap: 5px;
            padding: 5px 10px;
        }

        .lang button,
        .view-mode button {
            border: none;
            background: #fff;
            color: #000;
            padding: 6px 10px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
        }

        .lang button:hover,
        .view-mode button:hover {
            background: #f0f0f0;
        }

        .popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .popup.hidden {
            display: none;
        }

        .popup-box {
            background: #fff;
            color: #000;
            padding: 20px;
            width: 90%;
            max-width: 320px;
            border-radius: 12px;
            text-align: center;
        }

        body.dark .popup-box {
            background: #1a1a1a;
            color: #fff;
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 6px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress div {
            height: 100%;
            width: 0%;
            background: #1877f2;
            transition: width .2s;
        }

        .popup-box button {
            margin-top: 10px;
            padding: 8px 14px;
            background: #1877f2;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <header>PS4 Payload Loader</header>
    <div id="status">Detecting firmware…</div>

    <div class="controls" id="categoryButtons">
        <button class="active" onclick="filterCat('all', this)">All</button>
        <button onclick="filterCat('system', this)">System</button>
        <button onclick="filterCat('tools', this)">Tools</button>
    </div>

    <div class="container" id="list"></div>

    <div class="view-mode" style="right:10px;">
        <button onclick="setView('list', this)" class="active">List</button>
        <button onclick="setView('grid', this)">Grid</button>
    </div>

    <div class="lang" style="left:10px;">
        <button onclick="toggleDark()">Light/Dark</button>
        <button onclick="setLang('en')">EN</button>
        <button onclick="setLang('ar')">AR</button>
    </div>

    <script>
        let LANG = "en";
        let CAT = "all";
        let VIEW = "list";
        let DARK = false;

        const TEXT = { en: { send: "Send Payload", wait: "Waiting for GoldHEN…" }, ar: { send: "إرسال الحمولة", wait: "في انتظار GoldHEN…" } };

        const PAYLOADS = [
            { file: "ps4-app2usb-main.bin", cat: "tools", size: 22548, name: { en: "App2USB", ar: "نقل الألعاب USB" }, desc: { en: "Moves games to USB", ar: "نقل الألعاب إلى USB" } },
            { file: "ps4-backup-main.bin", cat: "system", size: 13556, name: { en: "Backup", ar: "نسخ احتياطي" }, desc: { en: "Creates system backup", ar: "إنشاء نسخة احتياطية" } },
            { file: "ps4-disable-updates-main.bin", cat: "system", size: 7812, name: { en: "Disable Updates", ar: "تعطيل التحديثات" }, desc: { en: "Blocks system updates", ar: "منع تحديثات النظام" } },
            { file: "ps4-enable-browser-main.bin", cat: "system", size: 9548, name: { en: "Enable Browser", ar: "تفعيل المتصفح" }, desc: { en: "Enables PS4 browser", ar: "تشغيل متصفح PS4" } },
            { file: "ps4-enable-updates-main.bin", cat: "system", size: 7788, name: { en: "Enable Updates", ar: "تفعيل التحديثات" }, desc: { en: "Restores updates", ar: "إرجاع التحديثات" } },
            { file: "ps4-fan-threshold-main.bin", cat: "tools", size: 8000, name: { en: "Fan Threshold", ar: "درجة حرارة المروحة" }, desc: { en: "Controls fan speed", ar: "التحكم بحرارة المروحة" } },
            { file: "ps4-ftp-main.bin", cat: "tools", size: 25716, name: { en: "FTP Server", ar: "سيرفر FTP" }, desc: { en: "Starts FTP server", ar: "تشغيل سيرفر FTP" } },
            { file: "ps4-history-blocker-main.bin", cat: "system", size: 9604, name: { en: "History Blocker", ar: "حظر السجل" }, desc: { en: "Blocks browser history", ar: "منع سجل المتصفح" } },
            { file: "ps4-kernel-dumper-main.bin", cat: "tools", size: 15884, name: { en: "Kernel Dumper", ar: "تفريغ الكيرنل" }, desc: { en: "Dumps kernel memory", ar: "تفريغ الذاكرة" } },
            { file: "ps4-restore-main.bin", cat: "system", size: 9708, name: { en: "System Restore", ar: "استعادة النظام" }, desc: { en: "Restores settings", ar: "استعادة الإعدادات" } },
            { file: "ps4-rif-renamer-main.bin", cat: "tools", size: 8396, name: { en: "RIF Renamer", ar: "إعادة تسمية RIF" }, desc: { en: "Renames license files", ar: "إعادة تسمية التراخيص" } }
        ];

        function detectFW() {
            let fw = "Unknown";
            const ua = navigator.userAgent;
            if (/5\.05/.test(ua)) fw = "5.05";
            else if (/6\.72/.test(ua)) fw = "6.72";
            else if (/7\.55/.test(ua)) fw = "7.55";
            document.getElementById("status").textContent = `Firmware detected: ${fw}`;
        }
        detectFW();

        function render() {
            const list = document.getElementById("list");
            list.className = "container " + (VIEW === "grid" ? "grid" : "");
            list.innerHTML = "";
            const filtered = PAYLOADS.filter(p => CAT === "all" || p.cat === CAT);
            filtered.forEach(p => {
                const c = document.createElement("div");
                c.className = "card";
                if (VIEW === "grid") c.style.width = "calc(25% - 12px)"; // 4 columns
                else c.style.width = "100%";
                c.innerHTML = `<h2>${p.name[LANG]}</h2>
      <div class="desc">${p.desc[LANG]}</div>
      <div class="meta">${(p.size / 1024).toFixed(2)} KB</div>
      <button class="send" onclick="sendPayload('${p.file}')">${TEXT[LANG].send}</button>`;
                list.appendChild(c);
            });
        }

        function filterCat(c, btn) {
            CAT = c;
            document.querySelectorAll(".controls button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            render();
        }

        function setView(v, btn) {
            VIEW = v;
            document.querySelectorAll(".view-mode button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            render();
        }

        function setLang(l) {
            LANG = l;
            render();
        }

        function toggleDark() {
            DARK = !DARK;
            document.body.classList.toggle("dark", DARK);
        }
        render();
    </script>
    <script>
        /* ---------- PAYLOAD PROGRESS + SUCCESS ---------- */
        let progressTimer = null;

        function showProgress(name) {
            document.getElementById("popupTitle").textContent = "Sending " + name;
            document.getElementById("popupText").textContent = "Please wait…";
            document.getElementById("progressBar").style.width = "0%";
            document.getElementById("progressPopup").classList.remove("hidden");

            let p = 0;
            progressTimer = setInterval(() => {
                p += Math.random() * 12;
                if (p >= 95) p = 95;
                document.getElementById("progressBar").style.width = p + "%";
            }, 300);
        }

        function payloadSuccess() {
            clearInterval(progressTimer);
            document.getElementById("progressBar").style.width = "100%";
            document.getElementById("popupTitle").textContent = "Payload Sent!";
            document.getElementById("popupText").textContent = "Done successfully";

            setTimeout(() => {
                document.getElementById("progressPopup").classList.add("hidden");
            }, 1200);
        }

        /* Hook sendPayload safely */
        const _sendPayload = window.sendPayload;
        window.sendPayload = function (file) {
            showProgress(file);
            _sendPayload(file);
            setTimeout(payloadSuccess, 2500); // safe delay for PS4
        };

        /* ---------- OFFLINE CACHE ---------- */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        window.addEventListener("load", () => {
            if (localStorage.cached !== "yes") {
                setTimeout(() => {
                    localStorage.cached = "yes";
                    document.getElementById("cachePopup").classList.remove("hidden");
                }, 2000);
            }
        });
    </script>

    <script src="loader.js"></script>
    <!-- Progress Popup -->
    <div id="progressPopup" class="popup hidden">
        <div class="popup-box">
            <h3 id="popupTitle">Sending Payload…</h3>
            <div class="progress">
                <div id="progressBar"></div>
            </div>
            <p id="popupText">Please wait</p>
        </div>
    </div>

    <!-- Cache Done Popup -->
    <div id="cachePopup" class="popup hidden">
        <div class="popup-box">
            <h3>Offline Ready</h3>
            <p>Page cached successfully.<br>Reopen page for best performance.</p>
            <button onclick="location.reload()">Reopen</button>
        </div>
    </div>

</body>

</html>