<!DOCTYPE html>
<html>

<head>
  <title>PS4 Payload Loader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #2c3e50;
      --accent: #3498db;
      --accent-dark: #2980b9;
      --border: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --success: #27ae60;
      --error: #e74c3c;
      --warning: #f39c12;
      --log-bg: #1e1e1e;
      --log-text: #e0e0e0;
    }

    .dark-mode {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --accent: #4a9dec;
      --accent-dark: #2d80d6;
      --border: #333333;
      --shadow: rgba(0, 0, 0, 0.3);
      --log-bg: #0d0d0d;
      --log-text: #d0d0d0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 24px;
      color: var(--accent);
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 14px;
      margin-top: 5px;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-dark);
    }

    .btn.active {
      background: var(--success);
    }

    #search {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      width: 200px;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .grid.list-view {
      grid-template-columns: 1fr;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px var(--shadow);
    }

    .card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .card h3 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--accent);
    }

    .card .desc {
      font-size: 14px;
      color: var(--text);
      opacity: 0.8;
      margin-bottom: 15px;
    }

    .card .meta {
      font-size: 12px;
      color: #7f8c8d;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* LOGGER STYLES */
    .logger {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 300px;
      background: var(--log-bg);
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .logger-header {
      background: #2c3e50;
      color: white;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }

    .logger-header h3 {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logger-controls {
      display: flex;
      gap: 8px;
    }

    .logger-controls button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logger-controls button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--log-text);
      line-height: 1.4;
    }

    .log-entry {
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
      border-left: 2px solid transparent;
    }

    .log-entry::before {
      content: ">";
      position: absolute;
      left: 0;
      color: #7f8c8d;
    }

    .log-entry.info {
      border-left-color: var(--accent);
      color: #4a9dec;
    }

    .log-entry.success {
      border-left-color: var(--success);
      color: #2ecc71;
    }

    .log-entry.error {
      border-left-color: var(--error);
      color: #e74c3c;
    }

    .log-entry.warning {
      border-left-color: var(--warning);
      color: #f39c12;
    }

    .log-time {
      color: #7f8c8d;
      font-size: 10px;
      margin-right: 8px;
    }

    .logger-minimized {
      height: 40px;
      max-height: 40px;
    }

    .logger-minimized .log-content {
      display: none;
    }

    .log-indicator {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--error);
      z-index: 999;
      display: none;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      font-size: 14px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translate(-50%, 100%);
        opacity: 0;
      }

      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .logger {
        width: calc(100% - 40px);
        max-height: 200px;
        right: 20px;
        left: 20px;
      }

      #grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>PS4 Payload Loader</h1>
        <div class="subtitle">Firmware: <span id="fw-display">Unknown</span> | Port: 9090</div>
      </div>
      <div class="controls">
        <input type="text" id="search" placeholder="Search payloads...">
        <button id="toggle-layout-btn" class="btn">
          <span class="grid-text">üì± Grid</span>
          <span class="list-text" style="display:none">üìã List</span>
        </button>
        <button id="toggle-theme-btn" class="btn">
          <span class="light-text">üåô Dark</span>
          <span class="dark-text" style="display:none">‚òÄÔ∏è Light</span>
        </button>
        <button id="toggle-logger-btn" class="btn">üìã Log</button>
      </div>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <!-- Logger Panel -->
  <div class="logger" id="logger">
    <div class="logger-header" id="logger-header">
      <h3>üìã Debug Console <span id="log-count">(0)</span></h3>
      <div class="logger-controls">
        <button id="clear-log-btn" title="Clear Log">üóëÔ∏è</button>
        <button id="minimize-log-btn" title="Minimize">‚ûñ</button>
        <button id="close-log-btn" title="Close">‚úï</button>
      </div>
    </div>
    <div class="log-content" id="log-content">
      <!-- Log entries will appear here -->
    </div>
  </div>

  <!-- Error Indicator -->
  <div class="log-indicator" id="log-indicator"></div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ================= CONFIG & DATA =================
    const BINLOADER_URL = "http://127.0.0.1:9090";
    const PAYLOAD_DIR = "payloads/";

    // Payload Data Structure
    const payloads = [
      { name: "app2usb.bin", desc: "Moves games to USB storage", sizeKB: 22.0 },
      { name: "backup.bin", desc: "Creates system backup", sizeKB: 13.2 },
      { name: "disable-updates.bin", desc: "Blocks system updates", sizeKB: 7.6 },
      { name: "enable-browser.bin", desc: "Enables PS4 browser", sizeKB: 9.3 },
      { name: "enable-updates.bin", desc: "Restores system updates", sizeKB: 7.6 },
      { name: "fan-threshold.bin", desc: "Controls fan temperature", sizeKB: 7.8 },
      { name: "ftp.bin", desc: "Starts FTP server", sizeKB: 25.1 },
      { name: "history-blocker.bin", desc: "Blocks browser history", sizeKB: 9.4 },
      { name: "kernel-dumper.bin", desc: "Dumps kernel memory", sizeKB: 15.5 },
      { name: "restore.bin", desc: "Restores system settings", sizeKB: 9.5 },
      { name: "rif-renamer.bin", desc: "Renames license files", sizeKB: 8.2 }
    ];

    // ================= LOGGER SYSTEM =================
    const logs = [];
    let errorCount = 0;

    function log(type, message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = {
        type,
        message,
        data,
        timestamp,
        id: Date.now() + Math.random()
      };

      logs.push(logEntry);

      if (type === 'error') {
        errorCount++;
        updateLogIndicator();
      }

      renderLogEntry(logEntry);
      updateLogCount();
      saveLogsToStorage();

      // For debugging: Also log to browser console if available
      if (typeof console !== 'undefined' && console[type]) {
        console[type](`[${timestamp}] ${message}`, data || '');
      }
    }

    function renderLogEntry(entry) {
      const logContent = document.getElementById('log-content');
      const logElement = document.createElement('div');
      logElement.className = `log-entry ${entry.type}`;
      logElement.id = `log-${entry.id}`;

      const timeSpan = `<span class="log-time">[${entry.timestamp}]</span>`;
      const messageSpan = `<span class="log-message">${entry.message}</span>`;
      const dataSpan = entry.data ? `<div class="log-data">${JSON.stringify(entry.data, null, 2)}</div>` : '';

      logElement.innerHTML = `${timeSpan} ${messageSpan} ${dataSpan}`;
      logContent.appendChild(logElement);

      // Auto-scroll to bottom
      logContent.scrollTop = logContent.scrollHeight;
    }

    function clearLogs() {
      logs.length = 0;
      errorCount = 0;
      document.getElementById('log-content').innerHTML = '';
      updateLogCount();
      updateLogIndicator();
      localStorage.removeItem('ps4_logs');
      log('info', 'Logs cleared');
    }

    function updateLogCount() {
      const countElement = document.getElementById('log-count');
      countElement.textContent = `(${logs.length})`;
    }

    function updateLogIndicator() {
      const indicator = document.getElementById('log-indicator');
      if (errorCount > 0) {
        indicator.style.display = 'block';
        indicator.title = `${errorCount} error(s) detected`;
      } else {
        indicator.style.display = 'none';
      }
    }

    function saveLogsToStorage() {
      try {
        // Save only last 100 logs to avoid storage issues
        const logsToSave = logs.slice(-100);
        localStorage.setItem('ps4_logs', JSON.stringify(logsToSave));
      } catch (e) {
        // Silently fail if storage is full
      }
    }

    function loadLogsFromStorage() {
      try {
        const savedLogs = JSON.parse(localStorage.getItem('ps4_logs') || '[]');
        savedLogs.forEach(logEntry => {
          logs.push(logEntry);
          renderLogEntry(logEntry);
        });
        updateLogCount();

        // Count errors from loaded logs
        errorCount = logs.filter(log => log.type === 'error').length;
        updateLogIndicator();
      } catch (e) {
        log('error', 'Failed to load saved logs', e);
      }
    }

    // ================= STATE =================
    let selectedPayloadName = null;
    let favorites = JSON.parse(localStorage.getItem("fav") || "[]");
    let recent = JSON.parse(localStorage.getItem("recent") || "[]");

    // ================= UTILS & ELEMENTS =================
    const body = document.body;
    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("search");
    const themeBtn = document.getElementById('toggle-theme-btn');
    const layoutBtn = document.getElementById('toggle-layout-btn');
    const fwDisplay = document.getElementById("fw-display");

    // Toast element
    const toast = document.getElementById('toast');

    // Utility to show temporary message
    function showToast(message) {
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 3000);
    }

    // PS4 Firmware detection
    function detectFW() {
      const m = navigator.userAgent.match(/PlayStation 4\/([0-9.]+)/);
      const fw = m ? m[1] : "Unknown";
      fwDisplay.textContent = fw;
      log('info', `Detected PS4 Firmware: ${fw}`, { userAgent: navigator.userAgent });
      return fw;
    }

    // ================= BINLOADER =================
    async function injectPayload(fileName) {
      log('info', `Starting injection: ${fileName}`);

      // Clear any existing selection highlight immediately
      document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
      selectedPayloadName = null;

      showToast(`Injecting ${fileName}...`);

      try {
        log('info', `Fetching payload from: ${PAYLOAD_DIR + fileName}`);
        const response = await fetch(PAYLOAD_DIR + fileName);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.arrayBuffer();
        log('info', `Payload loaded: ${data.byteLength} bytes`);

        log('info', `Sending to binloader: ${BINLOADER_URL}`);
        const binloaderResponse = await fetch(BINLOADER_URL, {
          method: "POST",
          body: data,
          headers: {
            'Content-Type': 'application/octet-stream'
          }
        });

        log('success', `Payload sent to binloader`, {
          status: binloaderResponse.status,
          statusText: binloaderResponse.statusText
        });

        showToast(`${fileName} sent successfully!`);

        // Update recent list
        recent = [fileName, ...recent.filter(f => f !== fileName)].slice(0, 5);
        localStorage.setItem("recent", JSON.stringify(recent));
        log('info', `Updated recent payloads`, recent);

        // Re-render to update the 'Recent' label on the card
        render();

      } catch (error) {
        log('error', `Injection failed: ${error.message}`, {
          fileName,
          error: error.toString()
        });
        console.error("Injection failed:", error);
        showToast("Injection failed. Check network (9090 port) or payload file.");
      }
    }

    // ================= HANDLERS =================
    function handleCardClick(clickedCard, payloadName) {
      log('info', `Card clicked: ${payloadName}`);

      // 1. Immediately highlight the card being injected
      document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
      clickedCard.classList.add('selected');
      selectedPayloadName = payloadName;

      // 2. Trigger the injection
      injectPayload(payloadName);
    }

    function handleCardDoubleClick(payloadName) {
      log('info', `Card double-clicked (favorite toggle): ${payloadName}`);

      // Toggle favorite state
      favorites = favorites.includes(payloadName)
        ? favorites.filter(f => f !== payloadName)
        : [...favorites, payloadName];
      localStorage.setItem("fav", JSON.stringify(favorites));

      render(); // Re-render to update the star/favorite label

      const message = favorites.includes(payloadName)
        ? `${payloadName} added to favorites`
        : `${payloadName} removed from favorites`;

      showToast(message);
      log('info', message);
    }

    // --- Theme Toggle Logic ---
    function toggleTheme() {
      body.classList.toggle('dark-mode');
      const isDarkMode = body.classList.contains('dark-mode');

      // Update button text visibility
      document.querySelector('.light-text').style.display = isDarkMode ? 'none' : 'inline';
      document.querySelector('.dark-text').style.display = isDarkMode ? 'inline' : 'none';

      // Update button title (tooltip)
      themeBtn.title = isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode';

      log('info', `Theme changed to ${isDarkMode ? 'dark' : 'light'} mode`);
    }

    themeBtn.addEventListener('click', toggleTheme);

    // Initialize theme based on system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      if (!body.classList.contains('dark-mode')) {
        toggleTheme();
      }
    }

    // --- Layout Toggle Logic ---
    function toggleLayout() {
      const isListView = grid.classList.toggle('list-view');

      // Update button text visibility
      document.querySelector('.grid-text').style.display = isListView ? 'none' : 'inline';
      document.querySelector('.list-text').style.display = isListView ? 'inline' : 'none';

      // Update button title (tooltip)
      layoutBtn.title = isListView ? 'Switch to Grid View' : 'Switch to List View';
      layoutBtn.classList.toggle('active', !isListView);

      log('info', `Layout changed to ${isListView ? 'list' : 'grid'} view`);
    }

    layoutBtn.addEventListener('click', toggleLayout);

    // ================= LOGGER CONTROLS =================
    function setupLoggerControls() {
      const logger = document.getElementById('logger');
      const loggerHeader = document.getElementById('logger-header');
      const minimizeBtn = document.getElementById('minimize-log-btn');
      const closeBtn = document.getElementById('close-log-btn');
      const clearBtn = document.getElementById('clear-log-btn');
      const toggleLoggerBtn = document.getElementById('toggle-logger-btn');

      let isDragging = false;
      let offsetX, offsetY;

      // Drag functionality for logger
      loggerHeader.addEventListener('mousedown', startDrag);
      loggerHeader.addEventListener('touchstart', startDragTouch);

      function startDrag(e) {
        isDragging = true;
        offsetX = e.clientX - logger.offsetLeft;
        offsetY = e.clientY - logger.offsetTop;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        e.preventDefault();
      }

      function startDragTouch(e) {
        if (e.touches.length === 1) {
          isDragging = true;
          const touch = e.touches[0];
          offsetX = touch.clientX - logger.offsetLeft;
          offsetY = touch.clientY - logger.offsetTop;
          document.addEventListener('touchmove', onDragTouch);
          document.addEventListener('touchend', stopDrag);
          e.preventDefault();
        }
      }

      function onDrag(e) {
        if (!isDragging) return;
        logger.style.left = (e.clientX - offsetX) + 'px';
        logger.style.top = (e.clientY - offsetY) + 'px';
        logger.style.right = 'auto';
      }

      function onDragTouch(e) {
        if (!isDragging || e.touches.length !== 1) return;
        const touch = e.touches[0];
        logger.style.left = (touch.clientX - offsetX) + 'px';
        logger.style.top = (touch.clientY - offsetY) + 'px';
        logger.style.right = 'auto';
      }

      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', onDragTouch);
        document.removeEventListener('touchend', stopDrag);
      }

      // Minimize button
      minimizeBtn.addEventListener('click', () => {
        logger.classList.toggle('logger-minimized');
        minimizeBtn.innerHTML = logger.classList.contains('logger-minimized') ? '‚ûï' : '‚ûñ';
        minimizeBtn.title = logger.classList.contains('logger-minimized') ? 'Expand' : 'Minimize';
        log('info', `Logger ${logger.classList.contains('logger-minimized') ? 'minimized' : 'expanded'}`);
      });

      // Close button
      closeBtn.addEventListener('click', () => {
        logger.style.display = 'none';
        toggleLoggerBtn.textContent = 'üìã Show Log';
        log('info', 'Logger closed');
      });

      // Clear button
      clearBtn.addEventListener('click', clearLogs);

      // Toggle logger button
      toggleLoggerBtn.addEventListener('click', () => {
        if (logger.style.display === 'none') {
          logger.style.display = 'flex';
          toggleLoggerBtn.textContent = 'üìã Hide Log';
          log('info', 'Logger opened');
        } else {
          logger.style.display = 'none';
          toggleLoggerBtn.textContent = 'üìã Show Log';
          log('info', 'Logger closed');
        }
      });
    }

    // ================= RENDER =================
    function render() {
      log('info', 'Rendering payload grid');

      grid.innerHTML = "";
      const q = searchInput.value.toLowerCase();

      // Use the original 'payloads' array to maintain fixed order
      payloads.forEach(p => {
        if (!p.name.toLowerCase().includes(q) && !p.desc.toLowerCase().includes(q)) return;

        const isFavorite = favorites.includes(p.name);
        const isRecent = recent.includes(p.name);

        const card = document.createElement("div");
        card.className = `card ${p.name === selectedPayloadName ? 'selected' : ''}`;

        card.innerHTML = `
                    <div>
                        <h3>${p.name}</h3>
                        <p class="desc">${p.desc}</p>
                    </div>
                    <div class="meta">
                        ${p.sizeKB} KB 
                        <span> ‚Ä¢ FW: ${detectFW()}</span>
                        ${isRecent ? ' ‚Ä¢ Recent' : ''}
                        ${isFavorite ? ' ‚Ä¢ ‚≠ê Favorite' : ''}
                    </div>
                `;

        // Single Click: Triggers Injection
        card.onclick = () => {
          handleCardClick(card, p.name);
        };

        // Double Click: Toggles Favorite
        card.ondblclick = (e) => {
          e.preventDefault();
          handleCardDoubleClick(p.name);
        };

        grid.appendChild(card);
      });

      log('info', `Rendered ${grid.children.length} payload cards`);
    }

    // ================= INITIALIZATION =================
    function init() {
      log('info', 'Initializing PS4 Payload Loader');
      log('info', `User Agent: ${navigator.userAgent}`);

      // Load saved logs
      loadLogsFromStorage();

      // Setup logger controls
      setupLoggerControls();

      // Detect firmware
      detectFW();

      // Initial event listeners and rendering
      searchInput.addEventListener('input', () => {
        log('info', `Search query: "${searchInput.value}"`);
        render();
      });

      render();

      // Test logging functions
      log('info', 'Application initialized successfully');
      log('warning', 'Remember: PS4 browser has limited JavaScript capabilities');
      log('success', 'Ready to inject payloads');

      // Test error
      setTimeout(() => {
        try {
          // Try to access a non-existent element to generate an error
          if (document.getElementById('nonexistent')) {
            // This won't execute
          }
        } catch (error) {
          log('error', 'Test error generated', error);
        }
      }, 1000);
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);

    // Global error handler
    window.onerror = function (message, source, lineno, colno, error) {
      log('error', `Unhandled error: ${message}`, {
        source,
        line: lineno,
        column: colno,
        error: error ? error.toString() : 'No error object'
      });
      return false;
    };

    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function (event) {
      log('error', 'Unhandled promise rejection', {
        reason: event.reason ? event.reason.toString() : 'Unknown reason'
      });
    });

    // Override console methods to also log to our logger
    if (typeof console !== 'undefined') {
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info
      };

      console.log = function (...args) {
        log('info', args.join(' '));
        originalConsole.log.apply(console, args);
      };

      console.error = function (...args) {
        log('error', args.join(' '));
        originalConsole.error.apply(console, args);
      };

      console.warn = function (...args) {
        log('warning', args.join(' '));
        originalConsole.warn.apply(console, args);
      };

      console.info = function (...args) {
        log('info', args.join(' '));
        originalConsole.info.apply(console, args);
      };
    }
  </script>
</body>

</html>